<!DOCTYPE html>
<html>

<head>
    <title>정산관리</title>
    <%- include('config') %>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js"></script>
    <script>
        $(function () {
            setChart();
            setPrice();
            setEnd();
            
        });

        function setChart() {
            var options = {
                maintainAspectRatio: true,
                spanGaps: false,
                elements: {
                    line: {
                        tension: 0.4
                    }
                },
                scales: {
                    yAxes: [{
                        stacked: false,
                        ticks: {
                            beginAtZero: true
                        },
                        scaleLabel: {
                            display: true,
                            labelString: '금액'
                        }
                    }],
                    xAxes: [{
                        display: true,
                        type: 'category',
                        scaleLabel: {
                            display: false,
                            labelString: '월'
                        }
                    }],
                },
                tooltips: {
                    callbacks: {
                        title: function (tooltipItems, data) {
                            const month = data.labels[tooltipItems[0].index];
                            const title = month.split('-')[0] + '년 ' + month.split('-')[1] + '월';
                            return title;
                        },
                        label: function (tooltipItems, data) {
                            var index = tooltipItems.index;
                            var value = `₩` + data.datasets[0].data[index].toLocaleString();
                            return value;
                        }
                    }
                },
                legend: {
                    display: false
                }

            };
            var ctx = document.getElementById('myChart').getContext('2d');
            var gradientAdd = ctx.createLinearGradient(0, 0, 0, 400);
            gradientAdd.addColorStop(0, 'rgba(119,100,228,1)');
            gradientAdd.addColorStop(1, 'rgba(119,100,228,0)');
            var label = [], data = [];
        <% for (var i = 0; i < total.length; i++) { %>
                label.push('<%=total[i].Ym.substring(0, 7)%>');
                data.push(<%=total[i].price %>);
        <% } %>
            var data = {
                labels: label,
                datasets: [{
                    borderColor: '#7764E4',
                    backgroundColor: gradientAdd,
                    data: data,
                    label: '',
                },
                ]
            };

            chart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: options
            });
        }

        function setPrice() {
            const total=$('.total');
            var total_price=0;
            for(var i=0; i<total.length; i++) {
                const price=$(total[i]).data('price');
                if(price) {
                    total_price+=price;
                }
            }
            $('#total-price').text('총 '+total_price.toLocaleString()+'원');
        }

        function setEnd() {
            $('#select-end').val('<%=end%>');
            $('#select-end').change(function() {
                const end=$(this).val();
                console.log(end);
                location.href=`?end=${end}`;
            });
        }
    </script>
</head>

<body>
    <%- include('nav') %>
    <section class="container-main">
        <div class="normal">
            <h4><b>수익 그래프</b></h4>
            <div class="card">
                <div class="card-body">
                    <canvas id="myChart" style="width: 100%; height: 300px;"></canvas>
                </div>
            </div>
            <br>
            <div class="horizontal between">
                <h4 class="card-title">세부 내역</h4>
                <select class="box0" id="select-end">
                    <% var month=new Date().getMonth()+1;
                    for(var i=1; i<=month; i++) { 
                        var date=new Date().getFullYear()+'-';
                        var value=new Date().getFullYear()+'-';
                        if(i<10) {
                            date+='0';
                        }
                        if(i<9) {
                            value+='0';
                        }
                        date+=i;
                        value+=i+1+'-01';
                        %>
                        <option value="<%=value%>"><%=date%></option>
                    <% } %>
                </select>
            </div>
            <br>

            <!-- detail -->
            <div class="card">
                <div class="card-body">
                    
                        <table>
                            <thead>
                                <th class="head">물류사</th>
                                <th class="head">노선</th>
                                <th class="head">통근 운임</th>
                                <th class="head">통근 비용</th>
                                <th class="head">통근 수수료</th>
                                <th class="head">통근 합계</th>
                                <th class="head">물류 운임</th>
                                <th class="head">물류 운임 합계</th>
                                <th class="head">총 합계</th>
                            </thead>
                            <tbody>
                                <%for(var i=0; i<bus.length; i++) { %>
                                    <tr>
                                        <td><%=bus[i].LogiName%></td>
                                        <td><%=bus[i].RouteCnt?bus[i].RouteCnt:0%>개</td>
                                        <td>노선당 <%=bus[i].RunFee?bus[i].RunFee.toLocaleString():0%>원</td>
                                        <td><%=bus[i].RouteCnt&&bus[i].RunFee?(bus[i].RunFee*bus[i].RouteCnt).toLocaleString():0%>원</td>
                                        <td><%=bus[i].RouteCnt&&bus[i].RunFee?(bus[i].RunFee*bus[i].RouteCnt*0.1).toLocaleString():0%>원</td>
                                        <td><%=bus[i].RouteCnt&&bus[i].RunFee?(bus[i].RunFee*bus[i].RouteCnt*0.9).toLocaleString():0%>원</td>
                                        <td>노선당 <%=bus[i].DefaultFee?bus[i].DefaultFee.toLocaleString():0%>원</td>
                                        <td><%=bus[i].DefaultFee&&bus[i].RouteCnt?(bus[i].DefaultFee*bus[i].RouteCnt).toLocaleString():0%>원</td>
                                        <td class="total" data-price="<%=bus[i].RouteCnt&&bus[i].RunFee&&bus[i].DefaultFee?((bus[i].RunFee*0.9+bus[i].DefaultFee)*bus[i].RouteCnt):0%>">
                                            <%=bus[i].RouteCnt&&bus[i].RunFee&&bus[i].DefaultFee?((bus[i].RunFee*0.9+bus[i].DefaultFee)*bus[i].RouteCnt).toLocaleString():0%>원
                                        </td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                        <br>
                        <div class=" horizontal between">
                            <label></label>
                            <h3 id="total-price"></h3>
                        </div>
                </div>
            </div>
        </div>
    </section>
</body>

</html>