<!DOCTYPE html>
<html>

<head>
    <%- include('config') %>
    <title>BusLinker 운행 현황</title>
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8d8a439d20cdda219547d464d94644cf&libraries=services"></script>
    <script>
        var map;
        $(function () {
            setMainHeight();
            initMap();

            initTab();
            initTable();
            initMapLocation();
            <% for (var i = 0; i < timeline.length; i++) {
                for (var j = 0; j < timeline[i].Loc.length; j++) {
                    if (timeline[i].Loc[j].LocCat == 4) { %>
                        addMarker(<%=timeline[i].Loc[j].Lat %>, <%=timeline[i].Loc[j].Lng %>, '<%=timeline[i].Loc[j].LocName%>', 3);
                <% }
                }
            }%>


            // 운행 버스 추가
            var geocoder = new kakao.maps.services.Geocoder();
            <% for (var i = 0; i < timeline.length; i++) { %>
                addMarker(<%=timeline[i].Lat ? timeline[i].Lat : 0 %>, <%=timeline[i].Lng ? timeline[i].Lng : 0 %>, '<%=timeline[i].Name%>', 1);
                // 물류사 추가
                geocoder.addressSearch('<%=timeline[i].LogiAddr%>', function (result, status) {
                    // 정상적으로 검색이 완료됐으면 
                    if (status === kakao.maps.services.Status.OK) {
                        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                        addMarker(result[0].y, result[0].x, '<%=timeline[i].Logi%>', 2);
                    }
                }); 
            <% } %>
                setCorpCnt();
            setArrow();
        });

        function initMap() {
            var mapContainer = document.getElementById('map');
            var mapOption = {
                center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
                level: 9 // 지도의 확대 레벨
            };
            // 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다

            map = new kakao.maps.Map(mapContainer, mapOption);
            // 지도 확대 축소를 제어할 수 있는  줌 컨트롤을 생성합니다
            var zoomControl = new kakao.maps.ZoomControl();
            map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
        }

        function setMainHeight() {
            var height = $(window).height();
            height -= 46;
            $('.conatiner').css('height', height);
        }

        function initTab() {
            // tab click
            $('.tab-item').click(function () {
                // change tab show
                $('.tab-active').removeClass('tab-active');
                $(this).addClass('tab-active');

                const filter = $(this).attr('data-filter');
                //hide all
                $('.tr').fadeOut(200);
                if (filter != -1)  //not all
                    $(`.tr[data-filter=${filter}]`).fadeIn(200);
                else //all
                    $('.tr').fadeIn(200);
            });
        }

        function initTable() {
            $('.tr').click(function () {
                const lat = $(this).attr('data-lat');
                const lng = $(this).attr('data-lng');

                if (lat && lng) {
                    var moveLatLon = new kakao.maps.LatLng(lat, lng);
                    map.setCenter(moveLatLon);
                    map.setLevel(5);
                }
            });

            const tr = $('.tr');
            for (var i = 0; i < tr.length; i++) {
                const lat = $(tr[i]).attr('data-lat');
                const lng = $(tr[i]).attr('data-lng');
                const title = $(tr[i]).attr('data-num');

                if (lat && lng) {
                    var imageSrc = '/public/images/bus_marker.svg', // 마커이미지의 주소입니다    
                        imageSize = new kakao.maps.Size(50, 50),
                        imageOption = { offset: new kakao.maps.Point(27, 69) };

                    var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
                    var markerPosition = new kakao.maps.LatLng(lat, lng);
                    var marker = new kakao.maps.Marker({
                        position: markerPosition,
                        image: markerImage,
                        title: title
                    });
                    marker.setMap(map);
                }
            }
        }

        // create each location marker
        function addMarker(lat, lng, name, cat) {

            if (lat == 0 && lng == 0)
                return;
            var imageSrc = '/public/images/bus_marker.svg', // 마커이미지의 주소입니다   
                imageSize = new kakao.maps.Size(50, 50);
            switch (cat) {
                // 운행 버스
                case 1:
                    imageSrc = '/public/images/bus_marker.svg';
                    break;
                case 2:
                    imageSrc = '/public/images/logi_marker.svg';
                    break;
                case 3:
                    imageSrc = '/public/images/owner_marker.svg';
                default:
                    break;
            }
            imageOption = { offset: new kakao.maps.Point(27, 69) };
            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption),
                markerPosition = new kakao.maps.LatLng(lat, lng);
            var markerPosition = new kakao.maps.LatLng(lat, lng);
            var marker = new kakao.maps.Marker({
                position: markerPosition,
                image: markerImage,
                title: name,
                clickble:true
            });

            var iwContent = `<div style="padding:10px;backgroud:url('/public/images/conversation.png')">
                            <p class='white size-14>${name}</p>
                            <p>dㅇㅇㅇㅇㅇ</p>
                            </div>`,
                iwPosition = new kakao.maps.LatLng(lat, lng);
            var infowindow = new kakao.maps.InfoWindow({
                position: iwPosition,
                content: iwContent,
                removable: true
            });
            marker.setMap(map);
            var click=false;
            kakao.maps.event.addListener(marker, 'click', function() {
               // 마커 위에 인포윈도우를 표시합니다
                infowindow.open(map, marker);  
            });
        }

        function initMapLocation() {
            const lat = $('.tr:first').attr('data-lat');
            const lng = $('.tr:first').attr('data-lng');
            if (lat && lng) {
                var moveLatLon = new kakao.maps.LatLng(lat, lng);
                map.setCenter(moveLatLon);
            } else {
                navigator.geolocation.getCurrentPosition(function (pos) {
                    var latitude = pos.coords.latitude;
                    var longitude = pos.coords.longitude;
                    var moveLatLon = new kakao.maps.LatLng(latitude, longitude);
                    map.setCenter(moveLatLon);
                });
            }
        }

        function setCorpCnt() {
            const small_tr = $('.small-tr');
            const corp_tr = $('.corp-tr');

            for (var i = 0; i < small_tr.length; i++) {
                for (var j = 0; j < corp_tr.length; j++) {
                    if ($(corp_tr[j]).data('corp') == $(small_tr[i]).data('corp')) {
                        $(corp_tr[j]).data('cnt', $(corp_tr[j]).data('cnt') + 1);
                    }
                }
            }
            for (var i = 0; i < corp_tr.length; i++) {
                const corp = $(corp_tr[i]).children('td').text();
                const cnt = $(corp_tr[i]).data('cnt');
                $(corp_tr[i]).children('td').children('div.horizontal.between').children('p').text(`${corp}(${cnt})`);
            }
        }

        function setArrow() {
            $('.arrow').click(function () {
                const open = $(this).data('open');
                const corp = $(this).data('corp');
                if (open == 1) {
                    // console.log($(`tr.small-tr[data-corp=${corp}]`));
                    $(`.small-tr[data-corp='${corp}']`).fadeOut(100);
                    $(this).data('open', 0);
                    $(this).attr('src', '/public/images/arrow_down.png');
                } else {
                    $(`.small-tr[data-corp='${corp}']`).fadeIn(100);
                    $(this).data('open', 1);
                    $(this).attr('src', '/public/images/arrow_up.png');
                }
            });
        }
    </script>
</head>

<body>
    <%- include('nav') %>
    <section>
        <!-- map -->
        <div id="map"></div>

        <!-- data list -->
        <div id="list">
            <div>
                <div id="table-container">
                    <div class=" horizontal">
                        <div style="width: 15px;"></div>
                        <div>
                            <label class="size-15">오늘의 운행 현황</label>
                            <h4 class=" size-25 primary"><b>총 <%=timeline.length%>대</b></h4>
                        </div>
                    </div>
                    <br>
                    <table style="width: 100%; background-color: #F4F4F4;" class="table-hover">
                        <% for(var i=0; i<timeline.length; i++) { %>
                        <% if(i==0|| (i!=0 && timeline[i].CorpID!=timeline[i-1].CorpID)) { %>
                        <tr class="corp-tr" data-corp="<%=timeline[i].CorpID%>" data-cnt="0">
                            <td class="corp-td" colspan="7">
                                <div class=" horizontal  between">
                                    <p><b><%=timeline[i].CorpName%></b></p>
                                    <img src="/public/images/arrow_up.png" width="24" height="15" class="arrow"
                                        data-open="1" data-corp="<%=timeline[i].CorpID%>">
                                </div>
                            </td>
                        </tr>
                        <% } %>
                        <tr class="tr small-tr" data-filter="0" data-lat="<%=timeline[i].Lat%>"
                            data-lng="<%=timeline[i].Lng%>" data-num="<%=timeline[i].Num%>"
                            data-corp="<%=timeline[i].CorpID%>">
                            <td><b class=" size-13"><%=timeline[i].Name%></b></td>
                            <td><%=timeline[i].DriverName?timeline[i].DriverName:'기사 미배정'%><br><%=timeline[i].Num?timeline[i].Num:'차량 미배정'%>
                            </td>
                            <% var start=timeline[i].Loc[0];
                                    var end=timeline[i].Loc[1];
                                    var time=new Date().getTime();
                                    for(var j=0; j<timeline[i].Loc.length; j++) {

                                        var d=new Date();
                                        var rcTime=new Date(d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate()+' '+timeline[i].Loc[j].RcTime).getTime();
                                         if(rcTime<time&&timeline[i].Loc[j+1]) {
                                            start=timeline[i].Loc[j];
                                            end=timeline[i].Loc[j+1]
                                         } %>
                            <% } %>
                            <td><span class="location-name"><b><%=start.LocName%></b></span><br><%=start.LocAddr%></td>
                            <td><img src="/public/images/right_arrow.png"></td>
                            <td><span class="location-name"><b><%=end.LocName%></b></span><br><%=end.LocAddr%></td>
                            <td><b><%=timeline[i].Action?timeline[i].Action:'운행 준비중'%></b></td>
                            <td><%=timeline[i].PtName?timeline[i].PtName:'물류관리 직원 미배정'%><br><%=timeline[i].PtPhone%>
                            </td>
                        </tr>
                        <% } %>
                    </table>
                </div>
                </di>
            </div>
        </div>
    </section>
</body>

</html>