<!DOCTYPE html>
<html>

<head>
    <%- include('config') %>
    <title>차량 관리</title>
    <script>
        $(function () {
            $('#add-tr').hide();
            $('#modal').hide();
            $('#add-btn').click(function () {
                $('#add-tr').toggle(500);
            });
            $('#yes').click(function () {
                if ($('#car-num').val()) {
                    createBus();
                } else {
                    alert('차량 번호를 입력하세요.');
                }
            });
            $('#no').click(function () {
                $('#car-num').val('');
                $('#add-tr').hide(500);
            });

            $('.remove-btn').click(function () {
                const id = $(this).data('id');
                if (confirm('차량을 삭제하시겠습니까?')) {
                    removeBus(id);
                }
            });


            $('.remove-driver-btn').click(function () {
                const name = $(this).data('name');
                const id = $(this).data('id');
                if (confirm(name + ' 기사를 제거하시겠습니까?')) {
                    $.post("/Bus/Manage/Remove/Driver", { id: id }, function (data) {
                        if (data.Result) {
                            alert('기사가 제거되었습니다.');
                            location.reload();
                        } else {
                            alert('오류가 발생하였습니다.');
                        }
                    });
                }
            });
            $('#add-driver-btn').click(function () {
                location.href = '/Bus/Manage/Create/Driver';
            });

            $('#close-btn').click(function(){
                $('#modal').fadeOut(300);
            });

            setLink();
            setSearch();
        });

        function createBus() {
            $.ajax({
                url: "/Bus/Manage/Create/Bus",
                type: "post",
                data: {
                    num: $('#car-num').val()
                },
                dataType: "json",
                success: function (data) {
                    if (data.Result) {
                        alert('차량이 등록되었습니다');
                        location.reload();
                    } else {
                        alert('오류가 발생하였습니다');
                    }
                },
                error: function (err) {
                }
            });
        }

        function removeBus(id) {
            $.ajax({
                url: "/Bus/Manage/Remove/Bus",
                type: "post",
                data: {
                    id: id
                },
                dataType: "json",
                success: function (data) {
                    if (data.Result) {
                        alert('차량이 삭제되었습니다.');
                        location.reload();
                    } else {
                        alert('오류가 발생하였습니다.');
                    }
                },
                error: function (err) {
                }
            });
        }

        function setLink() {
            $('.link').click(function(){
                const cat=$(this).data('cat');
                const id=$(this).data('id');
                const name=$(this).data('name');
                if(cat=='bus') {
                    $('#schedule-name').text(name);
                    $('#iframe').attr('src', '/Bus/View/Schedule?bus='+id);
                    $('#modal').fadeIn(300);
                } else if(cat=='driver') {
                    $('#schedule-name').text(name+' 기사');
                    $('#iframe').attr('src', '/Bus/View/Schedule?driver='+id);
                    $('#modal').fadeIn(300);
                }
            });
        }

        function setSearch() {
            $('#search-driver').keyup(function() {
                const name=$(this).val();
                if(name.length>0) {
                    $(`.driver-tr[data-name!=${name}]`).hide();
                    $(`.driver-tr[data-name*=${name}]`).show();
                } else {
                    $(`.driver-tr`).show();
                }
            });
            $('#search-bus').keyup(function() {
                const num=$(this).val();
                if(num.length>0) {
                    $(`.bus-tr[data-num!=${num}]`).hide();
                    $(`.bus-tr[data-num*=${num}]`).show();
                } else {
                    $(`.bus-tr`).show();
                }
            });
        }
    </script>
</head>

<body style="background-color: #f5f5f5;">
    <div id="modal">
        <div class="big-popup">
                <div class="samll-popup-header">
                    <label class=" small-popup-title"><b><span id="schedule-name">이름</span>의 일정</b></label>
                    <img src="/public/images/popup_x_white.svg" id="close-btn" class="close">
                </div>
                <br>
                <div class=" small-popup-contents">
                    <iframe id="iframe" style="width: 45vw; height: 70vh; border: none;">
                    </iframe>
                </div>
        </div>
    </div>
    <%- include('nav') %>
    <section class="container-main">
        <br><br>
        <div class="horizontal between" style="width: 96%; align-items: baseline;">
            <!-- bus list -->
            <div class="card3d" style="width: 48.5%; height: 100%;">
                <div class="card-body">
                    <div class="horizontal between">
                        <div>
                            <label>차량 현황</label>
                            <div class="horizontal">
                                <h3>총 <%=busList.length%>대</h3>
                            </div>
                        </div>
                        <div class="bottom-line horizontal" >
                            <input style="width: 100%;" class="transparent" placeholder="차량 번호 검색" id="search-bus">
                            <img src="/public/images/search.svg" id="search-btn">
                        </div>
                    </div>
                    <table class="table table-borderless">
                        <thead class="blue">
                            <tr>
                                <th style="width: 50px;"></th>
                                <th class="blue">
                                    <div class="th-down">
                                        <label>차량</label>
                                        <img src="/public/images/down.png" class="drop-down">
                                    </div>
                                </th>
                                <th class="blue">
                                    <div class="th-down">
                                        <label>일정</label>
                                    </div>
                                </th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- add btn -->
                            <tr>
                                <td colspan="4">
                                    <div style="width: 100%; text-align: center;">
                                        <div style="cursor: pointer;" id="add-btn">
                                            <br>
                                            <img src="/public/images/add.svg" class="add-icon">
                                            <p class="size-13 add-txt"><b>차량 추가</b></p>
                                        </div>
                                </td>
                            </tr>
                            <!-- add form -->
                            <tr id="add-tr" style="height: 80px;">
                                <td><label></label></td>
                                <td><input style="width: 180px;" class="box0" placeholder="차량번호를 입력해주세요" id="car-num">
                                </td>
                                <td style="vertical-align: middle;"><span class="link">일정</span></td>
                                <td style="width: 100px;">
                                    <div class="horizontal">
                                        <img src="/public/images/yes.svg" class="check_icon" id="yes">
                                        <img src="/public/images/remove.svg" class="check_icon" id="no">
                                    </div>
                                </td>
                            </tr>

                            <!-- real data -->
                            <% for(var i=0; i<busList.length; i++) { %>
                            <tr class="bus-tr stp-grey" data-num="<%=busList[i].Num%>">
                                <td style="width: 50px; vertical-align: middle;">
                                    <img src="/public/images/remove.svg" class="check_icon remove-btn" data-id="<%=busList[i].ID%>"></td>
                                <td style="width: 200px; vertical-align: middle;">
                                    <span class=" size-12"><b><%=busList[i].Num%></b></span>
                                </td>
                                <td style="vertical-align: middle;"><span class="link" data-id="<%=busList[i].ID%>" data-cat="bus" data-name="<%=busList[i].Num%>">일정 상세보기</span></td>
                                <td></td>
                            </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- driver list -->
            <div class="card3d" style="width: 48.5%; height: 100%;">
                <div class="card-body">
                    <div class="horizontal between">
                        <div>
                            <label>기사 현황</label>
                            <div class="horizontal">
                                <h3>총 <%=driverList.length%>명</h3>
                            </div>
                        </div>
                        <div class="bottom-line horizontal" >
                            <input style="width: 100%" class="transparent" placeholder="이름 검색" id="search-driver">
                            <img src="/public/images/search.svg" id="search-btn">
                        </div>
                    </div>
                    <table class="table table-borderless">
                        <thead class="blue">
                            <tr>
                                <th></th>
                                <th class="blue">
                                    <div class="th-down">
                                        <label>이름</label>
                                        <img src="/public/images/down.png" class="drop-down">
                                    </div>
                                </th>
                                <th class="blue">
                                    <div class="th-down">
                                        <label>연락처</label>
                                        <img src="/public/images/down.png" class="drop-down">
                                    </div>
                                </th>
                                <th class="blue">
                                    <div class="th-down">
                                        <label>일정</label>
                                        <img src="/public/images/down.png" class="drop-down">
                                    </div>
                                </th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody style="text-align: center;">
                            <tr>
                                <td colspan="4">
                                    <div style="width: 100%; text-align: center;">
                                        <div style="cursor: pointer;" id="add-driver-btn">
                                            <br>
                                            <img src="/public/images/add.svg" class="add-icon">
                                            <p class="size-13 add-txt"><b>기사 추가</b></p>
                                        </div>
                                </td>
                            </tr>
                            <% for(var i=-0; i<driverList.length; i++) { %>
                            <tr data-name="<%=driverList[i].Name%>" class="driver-tr stp-grey">
                                <td style="vertical-align: middle;"><img src="/public/images/remove.svg" class="check_icon remove-driver-btn"
                                        data-name="<%=driverList[i].Name%>" data-id="<%=driverList[i].ID%>"></td>
                                <td style="width: 220px;">
                                    <div class="horizontal"
                                        style="align-items: flex-start; margin-top: 10px; text-align: left;">
                                        <img src="/public/uploads/<%=driverList[i].ProfilePath%>" class="table-img">
                                        <div style="margin-left: 10px; margin-top: 5px;">
                                            <p><b><%=driverList[i].Name%></b></p>
                                            <p class="size-10" style="margin-top: -20px;"><%=driverList[i].ID%></p>
                                        </div>
                                    </div>
                                </td>
                                <td style="vertical-align: middle;"><b><%=driverList[i].Phone%></b></td>
                                <td style="vertical-align: middle;">
                                    <span class="link" data-id="<%=driverList[i].ID%>" data-cat="driver" data-name="<%=driverList[i].Name%>">일정 상세보기</span>
                                </td>
                            </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</body>

</html>