<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>BusLinker</title>
  <link rel="stylesheet" type="text/css" href="styles/index.css">
  <link rel="stylesheet" type="text/css" href="styles/font.css">
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="My PWA">
  <meta name="apple-mobile-web-app-title" content="My PWA">
  <meta name="msapplication-starturl" content="/">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="images/icons/icon-152x152.png">
  <meta name="msapplication-TileImage" content="images/icons/icon-144x144.png">
  <meta name="msapplication-TileColor" content="#2196f3">
  <meta name="theme-color" content="#2196f3">
  <script src="https://code.jquery.com/jquery-3.5.0.min.js"
    integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
  <script src="/scripts/jsQR.js"></script>
  <script>
    $(function () {
      const commute = $.cookie('commute');
      const title = $('#title');
      if (commute) {
        title.text('ì¶œê·¼');
      } else {
        title.text('í‡´ê·¼');
      }
      setCamera();
    });
    function setCamera() {
      $('#btn-camera').click(function () {
        $('#file').trigger('click');
      });

      $('#file').change(function () {
        readURL(this);
      });
    }
    function readURL(input) {
      if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {
          $('#qr').attr('src', e.target.result);
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      var video = document.createElement("video");
      var canvasElement = document.getElementById("canvas");
      var canvas = canvasElement.getContext("2d");
      var loadingMessage = document.getElementById("loadingMessage");
      var outputContainer = document.getElementById("output");
      var outputMessage = document.getElementById("outputMessage");
      var outputData = document.getElementById("outputData");

      function drawLine(begin, end, color) {
        canvas.beginPath();
        canvas.moveTo(begin.x, begin.y);
        canvas.lineTo(end.x, end.y);
        canvas.lineWidth = 4;
        canvas.strokeStyle = color;
        canvas.stroke();
      }
      // ì¹´ë©”ë¼ ì‚¬ìš©ì‹œ

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function (stream) {
         video.srcObject = stream;
        // video.setAttribute("playsinline", true);      // iOS ì‚¬ìš©ì‹œ ì „ì²´ í™”ë©´ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒì„ ì „ë‹¬
        video.play();
        requestAnimationFrame(tick);
        
      });

      function tick() {
        loadingMessage.innerText = "âŒ› ìŠ¤ìº” ê¸°ëŠ¥ì„ í™œì„±í™” ì¤‘ì…ë‹ˆë‹¤."
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          loadingMessage.hidden = true;
          canvasElement.hidden = false;
          outputContainer.hidden = false;
          // ì½ì–´ë“¤ì´ëŠ” ë¹„ë””ì˜¤ í™”ë©´ì˜ í¬ê¸°
          canvasElement.height = video.videoHeight;
          canvasElement.width = video.videoWidth;
          canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
          var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
          var code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert",
          });
          // QRì½”ë“œ ì¸ì‹ì— ì„±ê³µí•œ ê²½ìš°

          if (code) {
            // ì¸ì‹í•œ QRì½”ë“œì˜ ì˜ì—­ì„ ê°ì‹¸ëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì§€ëŠ” í…Œë‘ë¦¬ ìƒì„±
            drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF0000");
            drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF0000");
            drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF0000");
            drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF0000");
            outputMessage.hidden = true;
            outputData.parentElement.hidden = false;
            // QRì½”ë“œ ë©”ì‹œì§€ ì¶œë ¥
            alert(code.data);
            outputData.innerHTML = code.data;
            // returnì„ ì¨ì„œ í•¨ìˆ˜ë¥¼ ë¹ ì ¸ë‚˜ê°€ë©´ QRì½”ë“œ í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œëœë‹¤.
            // return;
          }
          // QRì½”ë“œ ì¸ì‹ì— ì‹¤íŒ¨í•œ ê²½ìš° 
          else {
            outputMessage.hidden = false;
            outputData.parentElement.hidden = true;
          }
        }
        requestAnimationFrame(tick);

      }

    });
  </script>
</head>

<body>
  <div class="header">
    <img src="/images/back_navy.png" class="btn-back">
    <p class=" size-14 navy" style="text-align: center;"><b id="title">ì¶œê·¼</b></p>
  </div>
  <br>
  <label class=" size-12 navy"><b>ê¸°ì‚¬ë‹˜ì˜ QRì½”ë“œë¥¼</b></label>
  <label class=" size-12 navy"><b>ì¹´ë©”ë¼ë¥¼ ì´ìš©í•´ ì°ì–´ì£¼ì„¸ìš”.</b></label>
  <div id="test">

		<h1>QR ì½”ë“œ ë¦¬ë”</h1>

		<div id="output">

			<div id="outputMessage">

				QRì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë…¸ì¶œì‹œì¼œ ì£¼ì„¸ìš”

			</div>

    		<div id="outputLayer" hidden>

    			<span id="outputData"></span>

    		</div>

		</div>

	</div>

	<div>&nbsp;</div>

	<div>

		<h1>ìŠ¤ìº”</h1>

		<div id="frame">

			<div id="loadingMessage">

				ğŸ¥ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì— ì•¡ì„¸ìŠ¤ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br/>ì›¹ìº ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤

			</div>

			<canvas id="canvas"></canvas>

		</div>

	</div>
  <img id="qr" style="width: 80%;">
  <input type="file" accept="image/*" capture="camera" id="file" hidden>
  <br>
  <button type="button" class=" btn-main" id="btn-camera">ì¹´ë©”ë¼ ì‹¤í–‰</button>
</body>